<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solana æ‰¹é‡æŸ¥è¯¢ï¼šSOL ä½™é¢ & USD æŠ˜ç®—ï¼ˆs.1b.tcï¼‰</title>
<style>
  :root{
    --bg:#f9fafb;--card:#fff;--text:#111827;--sub:#6b7280;--primary:#2563eb;
    --ok:#16a34a;--err:#dc2626;--bd:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",PingFang SC,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
  .wrap{max-width:980px;margin:28px auto;padding:22px}
  h2{margin:6px 0 18px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:18px;box-shadow:0 8px 20px rgba(0,0,0,.05)}
  textarea{width:100%;min-height:140px;border:1px solid var(--bd);border-radius:10px;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
  .row > *{flex:1}
  select,input[type="number"]{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px}
  button{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:12px 16px;cursor:pointer;font-weight:700}
  button:disabled{opacity:.6;cursor:not-allowed}
  table{width:100%;border-collapse:collapse;margin-top:18px}
  th,td{border:1px solid var(--bd);padding:10px 8px;text-align:center;white-space:nowrap}
  th{background:#f3f4f6}
  .note{color:var(--sub);font-size:13px;margin-top:8px}
  .muted{color:var(--sub)}
  .footer{margin-top:10px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .err{color:var(--err);font-weight:700}
  .total{font-weight:700}
  .left{text-align:left}
</style>
</head>
<body>
<div class="wrap">
  <h2>ğŸ“Š æ‰¹é‡æŸ¥è¯¢ Solana ä½™é¢ï¼ˆSOL â†’ USDï¼‰â€” ç›´è¿ <code>s.1b.tc</code></h2>

  <div class="card">
    <label>åœ°å€åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
    <textarea id="addrs" placeholder="ä¸€è¡Œä¸€ä¸ª Solana åœ°å€"></textarea>

    <div class="row">
      <div>
        <label>SOL ä»·æ ¼æº</label>
        <select id="priceSrc">
          <option value="max">ä¸¤è€…å–é«˜ï¼ˆæ¨èï¼‰</option>
          <option value="coingecko">CoinGecko</option>
          <option value="cryptocompare">CryptoCompare</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="run">å¼€å§‹æŸ¥è¯¢</button>
      </div>
    </div>

    <div class="note">
      â€¢ å‰ç«¯è¯·æ±‚å°†å‘é€åˆ°ä½ çš„ <code>/api/solana</code>ï¼ˆVercel æ— æœåŠ¡å™¨å‡½æ•°ï¼‰ï¼Œåç«¯**ç›´æ¥**è°ƒç”¨ <code>https://s.1b.tc/888/solana</code>ï¼Œæ— å…¶å®ƒæ•°æ®æºå›é€€ã€‚<br>
      â€¢ å¦‚æœç›®æ ‡æ¥å£å“åº”ç»“æ„ä¸ä½ é¢„æœŸä¸åŒï¼Œé¡µé¢ä¼šæç¤ºâ€œè¿”å›ç»“æ„æ— æ³•è¯†åˆ«â€ï¼Œæ­¤æ—¶è¯·æŠŠå®é™…è¿”å›æ ·ä¾‹ç²˜ç»™æˆ‘ä»¥ä¾¿å®šåˆ¶è§£æã€‚
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="footer">
      <div class="muted" id="status">å¾…å¼€å§‹</div>
      <div>
        <button id="export">å¯¼å‡º CSV</button>
      </div>
    </div>

    <table id="tbl" hidden>
      <thead>
        <tr>
          <th>#</th>
          <th class="left">åœ°å€</th>
          <th>SOL</th>
          <th>SOL å•ä»· (USD)</th>
          <th>æŠ˜ç®— (USD)</th>
          <th>æ•°æ®æ¥æº</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr class="total">
          <td colspan="2">åˆè®¡</td>
          <td id="sumSol">0</td>
          <td id="priceCell">â€”</td>
          <td id="sumUsd">$0.00</td>
          <td id="sourceCell">s.1b.tc</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const fmtSol = n => Number(n).toLocaleString('en-US',{maximumFractionDigits:9});
const fmtUsd = n => '$' + Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});

// --- ä»·æ ¼ ---
async function getSolPrice(src){
  async function cg(){
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
    const j = await r.json(); return j?.solana?.usd || 0;
  }
  async function cc(){
    const r = await fetch('https://min-api.cryptocompare.com/data/price?fsym=SOL&tsyms=USD');
    const j = await r.json(); return j?.USD || 0;
  }
  if(src==='coingecko') return {price: await cg(), source:'CoinGecko'};
  if(src==='cryptocompare') return {price: await cc(), source:'CryptoCompare'};
  const [a,b] = await Promise.all([cg(),cc()]);
  const price = Math.max(a||0,b||0);
  return {price, source: price===(a||0)?'CoinGeckoï¼ˆä¸¤è€…å–é«˜ï¼‰':'CryptoCompareï¼ˆä¸¤è€…å–é«˜ï¼‰'};
}

// --- ç›´è¿åç«¯ï¼ˆåç«¯å†ç›´è¿ s.1b.tcï¼‰ ---
async function queryBalances(addresses){
  const r = await fetch('/api/solana', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({addresses})
  });
  if(!r.ok) throw new Error('åç«¯è¿”å›çŠ¶æ€ï¼š'+r.status);
  const j = await r.json();
  if(!j || !j.ok || !j.balances) throw new Error(j?.error || 'è¿”å›ç»“æ„æ— æ³•è¯†åˆ«');
  return j.balances; // { address: lamports }
}

function toCSV(rows){
  return rows.map(r=>r.map(x=>String(x).includes(',')?`"${String(x).replace(/"/g,'""')}"`:x).join(',')).join('\n');
}

$('#run').addEventListener('click', async ()=>{
  const addrs = $('#addrs').value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(addrs.length===0){ alert('è¯·ç²˜è´´è‡³å°‘ä¸€ä¸ªåœ°å€'); return; }

  $('#tbl').hidden = false;
  $('#status').textContent = 'æ­£åœ¨è·å– SOL å•ä»·â€¦';
  $('tbody').innerHTML = '';
  $('#sumSol').textContent = '0';
  $('#sumUsd').textContent = '$0.00';
  $('#priceCell').textContent = 'â€”';
  $('#sourceCell').textContent = 's.1b.tc';

  const {price, source} = await getSolPrice($('#priceSrc').value);
  $('#priceCell').textContent = price ? fmtUsd(price) : 'â€”';
  $('#status').textContent = 'æ­£åœ¨é€šè¿‡åç«¯ç›´è¿ s.1b.tc æ‰¹é‡æŸ¥è¯¢â€¦';

  try{
    const balances = await queryBalances(addrs); // {addr: lamports}
    const rows = [];
    let sumSol = 0, sumUsd = 0;

    addrs.forEach((addr, i)=>{
      const lamports = Number(balances[addr] ?? 0);
      const sol = lamports / 1e9;
      const usd = sol * (price||0);
      sumSol += sol; sumUsd += usd;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="left">${addr}</td>
        <td>${fmtSol(sol)}</td>
        <td>${fmtUsd(price||0)}</td>
        <td>${fmtUsd(usd)}</td>
        <td>s.1b.tc</td>`;
      $('tbody').appendChild(tr);
      rows.push([i+1, addr, sol, price||0, usd, 's.1b.tc']);
    });

    $('#sumSol').textContent = fmtSol(sumSol);
    $('#sumUsd').textContent = fmtUsd(sumUsd);
    $('#status').textContent = `å®Œæˆï¼š${addrs.length} ä¸ªåœ°å€ï¼ˆä»·æ ¼æºï¼š${source}ï¼‰`;

    $('#export').onclick = ()=>{
      const header = [['#','Address','SOL','SOL Price (USD)','Total (USD)','Source']];
      const csv = toCSV(header.concat(rows));
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'sol_balances.csv';
      a.click();
    };
  }catch(e){
    $('#status').textContent = 'æŸ¥è¯¢å¤±è´¥ï¼š' + (e?.message || e);
    alert('æŸ¥è¯¢å¤±è´¥ï¼š' + (e?.message || e));
  }
});
</script>
</body>
</html>
